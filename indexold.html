<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backyard Ultra Terrassa</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        background-color: #121212;
        color: #ffffff;
        font-family: Arial, sans-serif;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }
      .lang-switcher {
        position: absolute;
        top: 12px;
        right: 12px;
      }
      .lang-switcher select {
        background: #1e1e1e;
        color: #fff;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 6px 8px;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      p {
        font-size: 1.25rem;
        margin: 10px 0;
      }

      .emoji-art {
        font-size: 2rem;
        margin-top: 20px;
      }

      .logo-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 30px;
        width: 100%;
        max-width: 600px;
      }

      .logo-container img {
        width: 100%;
        max-width: 300px;
        height: auto;
      }

      @media (max-width: 480px) {
        h1 {
          font-size: 1.8rem;
        }

        p {
          font-size: 1rem;
        }

        .emoji-art {
          font-size: 1.5rem;
        }

        .logo-container img {
          max-width: 80%;
        }
      }

      /* Preregistration form styles */
      .card {
        background: #1e1e1e;
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 20px;
        margin-top: 24px;
        width: 100%;
        max-width: 560px;
        text-align: left;
      }
      .card h2 {
        margin: 0 0 8px 0;
        font-size: 1.4rem;
      }
      .subtle {
        color: #cfcfcf;
        font-size: 0.95rem;
        margin: 0 0 12px 0;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .field {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 200px;
        margin-bottom: 12px;
      }
      label {
        font-size: 0.95rem;
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="email"] {
        background: #121212;
        color: #fff;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 1rem;
        outline: none;
      }
      input[type="text"]:focus,
      input[type="email"]:focus {
        border-color: #555;
      }
      .checkbox {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin: 8px 0 12px 0;
      }
      .checkbox input {
        margin-top: 3px;
      }
      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      button[type="submit"] {
        background: #4caf50;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 1rem;
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .error {
        color: #ff6b6b;
        font-size: 0.95rem;
      }
      .success {
        color: #7cd992;
        font-size: 1rem;
      }
      /* Tooltip */
      .info {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .info-icon {
        display: inline-block;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 1px solid #aaa;
        color: #ddd;
        font-weight: 700;
        font-size: 0.85rem;
        line-height: 16px;
        text-align: center;
        cursor: default;
        position: relative;
      }
      .tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        top: 22px;
        left: 50%;
        transform: translateX(-50%);
        background: #222;
        color: #eee;
        border: 1px solid #333;
        padding: 10px 12px;
        border-radius: 8px;
        width: 280px;
        font-size: 0.9rem;
        line-height: 1.3;
        transition: opacity 0.15s ease-in-out;
        z-index: 10;
        text-align: left;
      }
      .tooltip::after {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #333;
      }
      .info-icon:hover .tooltip,
      .info-icon:focus .tooltip {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="lang-switcher" aria-label="Language">
      <select id="lang-select" aria-label="Language selector">
        <option value="ca">Catal√†</option>
        <option value="es">Espa√±ol</option>
        <option value="en">English</option>
      </select>
    </div>
    <div class="logo-container">
      <a
        href="https://www.instagram.com/backyardultraterrassa/"
        target="_blank"
      >
        <img src="logodarkmode.png" alt="Backyard Ultra Terrassa Logo" />
      </a>
    </div>
    <h1 id="page-title">üèÉ‚Äç‚ôÇÔ∏è Backyard Ultra Terrassa üèÉ‚Äç‚ôÄÔ∏è</h1>
    <p id="status-text"></p>
    <p id="std-text"></p>

    <div
      id="prereg-card"
      class="card"
      role="region"
      aria-labelledby="prereg-title"
    >
      <div
        class="info"
        style="justify-content: space-between; align-items: start"
      >
        <h2 id="prereg-title">Preregister for BYUT 2026</h2>
        <span class="info-icon" tabindex="0" aria-label="Info">
          i
          <span class="tooltip" id="tooltip-text" role="tooltip"></span>
        </span>
      </div>
      <p id="form-subtle" class="subtle"></p>

      <form id="prereg-form" novalidate>
        <div class="row">
          <div class="field">
            <label for="firstName" id="label-firstName">Name</label>
            <input
              id="firstName"
              name="firstName"
              type="text"
              autocomplete="given-name"
              required
            />
          </div>
          <div class="field">
            <label for="lastName" id="label-lastName">Last Name</label>
            <input
              id="lastName"
              name="lastName"
              type="text"
              autocomplete="family-name"
              required
            />
          </div>
        </div>
        <div class="field">
          <label for="email" id="label-email">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            inputmode="email"
            autocomplete="email"
            required
          />
        </div>

        <div class="checkbox">
          <input id="consent" name="consent" type="checkbox" required />
          <label id="label-consent" for="consent"></label>
        </div>

        <div
          id="form-error"
          class="error"
          role="alert"
          aria-live="polite"
          style="display: none"
        ></div>

        <!-- reCAPTCHA -->
        <div class="field">
          <label for="captcha" id="label-captcha">Verification</label>
          <div
            class="g-recaptcha"
            data-sitekey="6Lcm9L8rAAAAAEF5QyxE568jiw-XeEGT4VnvFsib"
            data-theme="dark"
          ></div>
        </div>

        <div class="actions">
          <button id="submit-btn" type="submit">Preregister</button>
          <span id="submit-status" class="subtle" aria-live="polite"></span>
        </div>
      </form>
    </div>

    <div id="prereg-success" class="card" style="display: none">
      <h2 id="success-title">You're on the list üéâ</h2>
      <p id="success-message" class="success">
        Thank you for preregistering. We‚Äôll email you a personal invitation
        before general registration opens.
      </p>
      <div id="success-summary" class="subtle" aria-live="polite"></div>
      <div class="actions" style="margin-top: 12px">
        <button id="register-another-btn" type="button">
          Pre-register someone else
        </button>
      </div>
    </div>

    <script>
      // ===== i18n support =====
      const I18N_KEY = "byut_lang";
      const i18n = {
        ca: {
          wip: "üöß En proc√©s... Estigueu atents! üöß",
          saveDate: "Guarda't la data üìÖ - 14 Mar√ß 2026",
          form: {
            title: "Preinscripci√≥ BYUT 2026",
            subtle: "Completeu tots els camps i accepteu la pol√≠tica de dades.",
          },
          labels: {
            firstName: "Nom",
            lastName: "Cognoms",
            email: "Correu electr√≤nic",
            captcha: "Verificaci√≥",
          },
          tooltip: {
            text: "La preinscripci√≥ no garanteix pla√ßa. Tothom qui es preinscrigui rebr√† un correu amb invitaci√≥ personal per inscriure‚Äôs abans que s‚Äôobri la inscripci√≥ general. Les dades personals s‚Äôutilitzen nom√©s per a la preinscripci√≥ i recordatoris, i s‚Äôeliminaran quan s‚Äôobri la inscripci√≥ oficial despr√©s d‚Äôenviar els recordatoris.",
          },
          consent: {
            label:
              "Autoritzo l‚Äôemmagatzematge de les meves dades personals d‚Äôacord amb la legislaci√≥ vigent a Espanya, nom√©s per a la preinscripci√≥ i recordatoris. Les dades s‚Äôeliminaran quan s‚Äôobri la inscripci√≥ oficial despr√©s d‚Äôenviar els recordatoris.",
          },
          actions: {
            submit: "Preinscriure",
            registerAnother: "Preinscriure una altra persona",
          },
          status: { submitting: "Enviant‚Ä¶" },
          success: {
            title: "Ja formes part de la llista üéâ",
            message:
              "Gr√†cies per la preinscripci√≥. T‚Äôenviarem una invitaci√≥ personal abans que s‚Äôobri la inscripci√≥ general.",
            duplicateTitle: "Ja est√†s preinscrit ‚úÖ",
            duplicateMessage:
              "Aquest correu ja √©s a la nostra llista de preinscripcions.",
          },
          summary: { label: "Resum:" },
          errors: {
            completeAllFields: "Completeu tots els camps.",
            invalidEmail: "Introdu√Øu un correu electr√≤nic v√†lid.",
            mustGrantPermission: "Heu d‚Äôacceptar la pol√≠tica de dades.",
            endpointMissing: "El punt d‚Äôenviament no est√† configurat.",
            captchaRequired: "Completeu el CAPTCHA.",
            captchaFailed:
              "La verificaci√≥ de CAPTCHA ha fallat. Torneu-ho a provar.",
            genericSubmitProblem:
              "Hi ha hagut un problema amb l‚Äôenviament. Torneu-ho a provar m√©s tard.",
          },
        },
        es: {
          wip: "üöß En progreso... ¬°Estad atentos! üöß",
          saveDate: "Guardate la fecha üìÖ - 14 Marzo 2026",
          form: {
            title: "Preinscripci√≥n BYUT 2026",
            subtle: "Completa todos los campos y acepta la pol√≠tica de datos.",
          },
          labels: {
            firstName: "Nombre",
            lastName: "Apellidos",
            email: "Correo electr√≥nico",
            captcha: "Verificaci√≥n",
          },
          tooltip: {
            text: "La preinscripci√≥n no garantiza plaza. Quienes se preinscriban recibir√°n un correo con invitaci√≥n personal para inscribirse antes de la apertura general. Los datos personales se usan solo para la preinscripci√≥n y recordatorios, y se eliminar√°n cuando se abra la inscripci√≥n oficial tras enviar los recordatorios.",
          },
          consent: {
            label:
              "Autorizo el almacenamiento de mis datos personales conforme a la legislaci√≥n vigente en Espa√±a, √∫nicamente para preinscripci√≥n y recordatorios. Los datos se eliminar√°n cuando se abra la inscripci√≥n oficial tras enviar los recordatorios.",
          },
          actions: {
            submit: "Preinscribirse",
            registerAnother: "Preinscribir a otra persona",
          },
          status: { submitting: "Enviando‚Ä¶" },
          success: {
            title: "Est√°s en la lista üéâ",
            message:
              "Gracias por preinscribirte. Te enviaremos una invitaci√≥n personal antes de la apertura general.",
            duplicateTitle: "Ya est√° preinscrito ‚úÖ",
            duplicateMessage:
              "Este correo ya figura en nuestra lista de preinscripci√≥n.",
          },
          summary: { label: "Resumen:" },
          errors: {
            completeAllFields: "Completa todos los campos.",
            invalidEmail: "Introduce un correo electr√≥nico v√°lido.",
            mustGrantPermission: "Debes aceptar la pol√≠tica de datos.",
            endpointMissing: "El endpoint no est√° configurado.",
            captchaRequired: "Completa el CAPTCHA.",
            captchaFailed:
              "La verificaci√≥n de CAPTCHA fall√≥. Int√©ntalo de nuevo.",
            genericSubmitProblem:
              "Hubo un problema con el env√≠o. Int√©ntalo m√°s tarde.",
          },
        },
        en: {
          wip: "üöß Work in Progress... Stay tuned! üöß",
          saveDate: "Save the date üìÖ - 14 March 2026",
          form: {
            title: "Preregister for BYUT 2026",
            subtle: "Please complete all fields and accept the data policy.",
          },
          labels: {
            firstName: "Name",
            lastName: "Last Name",
            email: "Email",
            captcha: "Verification",
          },
          tooltip: {
            text: "Preregistration does not guarantee entry. Everyone who preregisters will receive a personal email invitation to register before general registration opens. Personal data is used only for preregistration and reminders, and will be deleted when official registration opens after reminder emails are sent.",
          },
          consent: {
            label:
              "I grant permission to store my personal data in accordance with applicable laws in Spain, solely for preregistration and reminder purposes. Data will be deleted when official registration opens after reminder emails are sent.",
          },
          actions: {
            submit: "Preregister",
            registerAnother: "Pre-register someone else",
          },
          status: { submitting: "Submitting‚Ä¶" },
          success: {
            title: "You're on the list üéâ",
            message:
              "Thank you for preregistering. We‚Äôll email you a personal invitation before general registration opens.",
            duplicateTitle: "Already preregistered ‚úÖ",
            duplicateMessage:
              "This email is already on our preregistration list.",
          },
          summary: { label: "Summary:" },
          errors: {
            completeAllFields: "Please complete all fields.",
            invalidEmail: "Please enter a valid email address.",
            mustGrantPermission:
              "You must grant permission to store your data.",
            endpointMissing: "Submission endpoint is not configured yet.",
            captchaRequired: "Please complete the CAPTCHA.",
            captchaFailed: "Captcha verification failed. Please try again.",
            genericSubmitProblem:
              "There was a problem submitting your preregistration. Please try again later.",
          },
        },
      };

      const langSelect = document.getElementById("lang-select");
      let currentLang = localStorage.getItem(I18N_KEY) || "ca";
      langSelect.value = currentLang;

      function t(path) {
        const parts = path.split(".");
        let obj = i18n[currentLang] || i18n.ca;
        for (const p of parts) {
          obj = obj?.[p];
          if (obj === undefined) return path;
        }
        return obj;
      }

      function applyI18n() {
        document.getElementById("status-text").textContent = t("wip");
        document.getElementById("std-text").textContent = t("saveDate");
        document.getElementById("prereg-title").textContent = t("form.title");
        document.getElementById("form-subtle").textContent = t("form.subtle");
        document.getElementById("label-firstName").textContent =
          t("labels.firstName");
        document.getElementById("label-lastName").textContent =
          t("labels.lastName");
        document.getElementById("label-email").textContent = t("labels.email");
        document.getElementById("label-captcha").textContent =
          t("labels.captcha");
        document.getElementById("label-consent").textContent =
          t("consent.label");
        document.getElementById("submit-btn").textContent = t("actions.submit");
        document.getElementById("register-another-btn").textContent = t(
          "actions.registerAnother"
        );
        document.getElementById("tooltip-text").textContent = t("tooltip.text");
      }

      langSelect.addEventListener("change", () => {
        currentLang = langSelect.value;
        try {
          localStorage.setItem(I18N_KEY, currentLang);
        } catch (_) {}
        applyI18n();
      });

      applyI18n();

      // ===== Preregistration form logic =====
      // Replace this with your deployed Google Apps Script Web App URL.
      // See the instructions in my message to set it up.
      const GOOGLE_APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwfFER8-DY0dJJ-HEn35BiqZ3bURLoXdmIybdluH7NKGpDLct4kkhS1GD6UFMdDH687nQ/exec"; // e.g. https://script.google.com/macros/s/AKfycbx.../exec

      const form = document.getElementById("prereg-form");
      const submitBtn = document.getElementById("submit-btn");
      const errorBox = document.getElementById("form-error");
      const statusText = document.getElementById("submit-status");
      const successCard = document.getElementById("prereg-success");
      const preregCard = document.getElementById("prereg-card");
      const successTitle = document.getElementById("success-title");
      const successMessage = document.getElementById("success-message");
      const successSummary = document.getElementById("success-summary");
      const registerAnotherBtn = document.getElementById(
        "register-another-btn"
      );

      function showError(msg) {
        if (!errorBox) return;
        errorBox.style.display = "block";
        errorBox.textContent = msg;
      }
      function clearError() {
        if (!errorBox) return;
        errorBox.style.display = "none";
        errorBox.textContent = "";
      }
      function isValidEmail(email) {
        // Simple robust email validation pattern
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
        return re.test(String(email).trim());
      }
      function setSubmitting(submitting) {
        if (submitBtn) submitBtn.disabled = submitting;
        if (statusText)
          statusText.textContent = submitting ? t("status.submitting") : "";
      }
      function showSuccess({ firstName, lastName, email, duplicate = false }) {
        if (preregCard) preregCard.style.display = "none";
        if (successCard) successCard.style.display = "block";
        if (successTitle)
          successTitle.textContent = duplicate
            ? t("success.duplicateTitle")
            : t("success.title");
        if (successMessage)
          successMessage.textContent = duplicate
            ? t("success.duplicateMessage")
            : t("success.message");
        if (successSummary) {
          const parts = [firstName, lastName, email].filter(Boolean);
          successSummary.textContent = `${t("summary.label")} ${parts.join(
            " ¬∑ "
          )}`;
        }
      }

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearError();

        const firstName =
          document.getElementById("firstName")?.value?.trim() || "";
        const lastName =
          document.getElementById("lastName")?.value?.trim() || "";
        const email = document.getElementById("email")?.value?.trim() || "";
        const consent = Boolean(document.getElementById("consent")?.checked);

        if (!firstName || !lastName || !email) {
          showError(t("errors.completeAllFields"));
          return;
        }
        if (!isValidEmail(email)) {
          showError(t("errors.invalidEmail"));
          return;
        }
        if (!consent) {
          showError(t("errors.mustGrantPermission"));
          return;
        }
        if (!GOOGLE_APPS_SCRIPT_URL) {
          showError(t("errors.endpointMissing"));
          return;
        }

        setSubmitting(true);
        try {
          // Send as URL-encoded to keep it a CORS simple request (no preflight)
          // Captcha token (reCAPTCHA v2 checkbox)
          const captchaToken =
            typeof grecaptcha !== "undefined" && grecaptcha
              ? grecaptcha.getResponse()
              : "";
          if (!captchaToken) {
            showError(t("errors.captchaRequired"));
            return;
          }

          const body = new URLSearchParams({
            firstName,
            lastName,
            email,
            lang: currentLang,
            captcha: captchaToken,
          });
          const resp = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            },
            body,
          });
          if (!resp.ok) {
            throw new Error(`Request failed: ${resp.status}`);
          }
          const data = await resp.json().catch(() => ({}));
          // Server contract: { success: boolean, error?: string }
          if (data && data.success === true) {
            showSuccess({ firstName, lastName, email, duplicate: false });
          } else if (data && data.error === "duplicate_email") {
            // Treat as soft-success: already on the list
            showSuccess({ firstName, lastName, email, duplicate: true });
          } else if (data && data.error === "captcha_failed") {
            showError(t("errors.captchaFailed"));
          } else if (data && typeof data.error === "string") {
            showError(data.error);
          } else {
            showError(t("errors.genericSubmitProblem"));
          }
        } catch (err) {
          console.error(err);
          showError(t("errors.genericSubmitProblem"));
        } finally {
          setSubmitting(false);
          try {
            if (typeof grecaptcha !== "undefined" && grecaptcha)
              grecaptcha.reset();
          } catch (_) {}
        }
      });

      // Allow multiple preregistrations: reset form and show again
      registerAnotherBtn?.addEventListener("click", () => {
        try {
          form?.reset();
        } catch (_) {}
        clearError();
        if (statusText) statusText.textContent = "";
        if (successCard) successCard.style.display = "none";
        if (preregCard) preregCard.style.display = "block";
        try {
          if (typeof grecaptcha !== "undefined" && grecaptcha)
            grecaptcha.reset();
        } catch (_) {}
        document.getElementById("firstName")?.focus();
      });
    </script>
    <!-- reCAPTCHA API (Catalan by default) -->
    <script
      src="https://www.google.com/recaptcha/api.js?hl=ca"
      async
      defer
    ></script>
  </body>
</html>
